<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
<title>MevlÃ¼t & AyÅŸegÃ¼l</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="image_0.png" type="image/png">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#050406;--head:rgba(20,10,30,0.85);--chat:#0b0712;--in:#1a1623;--ac:#9b59b6;--ac-g:rgba(155,89,182,0.5);--ac-grad:linear-gradient(135deg,#8e44ad,#6c5ce7);--me:linear-gradient(135deg,#6D214F,#2c3e50);--you:#1f1b26;--txt:#ecf0f1;--sec:#95a5a6;--d:#e74c3c;--s:#2ecc71;--h:100dvh}*{box-sizing:border-box}body{margin:0;font-family:'Outfit',sans-serif;background-color:var(--bg);color:var(--txt);height:var(--h);display:flex;flex-direction:column;overflow:hidden}::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:#4a3b55;border-radius:10px}::-webkit-scrollbar-thumb:hover{background:var(--ac)}.hidden{display:none!important}#auth-screen,#room-pass-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at center,#2e1a38 0%,#050406 100%);z-index:9999;display:flex;flex-direction:column;justify-content:center;align-items:center}.auth-container{width:90%;max-width:380px;text-align:center;background:rgba(255,255,255,0.03);backdrop-filter:blur(15px);padding:35px;border-radius:25px;border:1px solid rgba(255,255,255,0.08);box-shadow:0 20px 50px rgba(0,0,0,0.6);animation:f 0.5s ease-out}@keyframes f{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.auth-tabs{display:flex;justify-content:center;margin-bottom:25px;gap:15px}.auth-tab{padding:8px 16px;cursor:pointer;color:var(--sec);font-weight:600;transition:0.3s;border-radius:20px;font-size:14px}.auth-tab:hover{background:rgba(255,255,255,0.05)}.auth-tab.active{background:var(--ac);color:white;box-shadow:0 4px 15px var(--ac-g)}.auth-form{display:none;flex-direction:column;gap:15px}.auth-form.active{display:flex}.login-input{padding:15px;border-radius:15px;border:1px solid rgba(255,255,255,0.1);text-align:center;font-size:16px;background:rgba(0,0,0,0.2);color:white;outline:none;transition:0.3s}.login-input:focus{border-color:var(--ac);background:rgba(0,0,0,0.4);box-shadow:0 0 15px rgba(142,68,173,0.2)}button.primary-btn{padding:15px;border-radius:15px;border:none;background:var(--ac-grad);font-weight:600;cursor:pointer;font-size:15px;color:white;transition:0.3s;box-shadow:0 5px 20px rgba(0,0,0,0.3)}button.primary-btn:active{transform:scale(0.98)}.status-msg{margin-top:15px;font-size:14px;min-height:20px;font-weight:500}.error{color:#ff6b6b}.success{color:#1dd1a1}#app-header{background:var(--head);backdrop-filter:blur(10px);padding:12px 18px;display:flex;align-items:center;justify-content:space-between;z-index:100;border-bottom:1px solid rgba(255,255,255,0.05)}.header-info{display:flex;align-items:center;gap:14px}.header-avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid var(--ac);box-shadow:0 0 15px var(--ac-g)}.header-text h3{margin:0;font-size:18px}.header-text span{font-size:12px;color:var(--s);display:flex;align-items:center;gap:5px}.header-actions{display:flex;gap:8px}.circle-btn{width:40px;height:40px;border-radius:12px;border:none;background:rgba(255,255,255,0.05);color:#ccc;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:0.3s}.circle-btn:hover{background:rgba(255,255,255,0.15);color:white;transform:translateY(-2px)}.circle-btn.active{background:var(--ac);color:white;box-shadow:0 0 15px var(--ac-g)}.circle-btn.screen-active{background:#0984e3;color:white;box-shadow:0 0 15px rgba(9,132,227,0.6)}#video-container{background:#000;overflow:hidden;height:180px;transition:height 0.4s;flex-shrink:0;position:relative;border-bottom:1px solid rgba(255,255,255,0.1)}#video-container.collapsed{height:0;border:none}#video-grid{display:flex;overflow-x:auto;gap:12px;height:100%;padding:15px;align-items:center}video{height:100%;border-radius:12px;border:2px solid #333;min-width:150px;background:#151515;cursor:pointer;transition:0.3s;box-shadow:0 5px 15px rgba(0,0,0,0.5);touch-action:manipulation}video:hover{border-color:var(--ac);transform:scale(1.03)}video.screen-mode{object-fit:contain;border-color:#0984e3}#main-container{display:none;flex:1;height:100%;flex-direction:column;position:relative}#chat-wrapper{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}#chat-area{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:10px;background:var(--chat)} 
/* YENÄ° STÄ°LLER */
.message{max-width:80%;padding:12px 16px;border-radius:18px;font-size:15px;margin-bottom:2px;position:relative;word-wrap:break-word;box-shadow:0 2px 8px rgba(0,0,0,0.2);animation:f 0.2s;cursor:pointer;transition:background 0.2s}.message:hover{filter:brightness(1.1)}
.message.mine{align-self:flex-end;background:var(--me);color:white;border-bottom-right-radius:4px}.message.theirs{align-self:flex-start;background:var(--you);border-bottom-left-radius:4px;color:#dcdde1}
.message.big-emoji {font-size: 40px; background: transparent !important; padding: 0; box-shadow: none;}
.message.system-status{align-self:center;background:transparent;color:var(--sec);font-size:12px;font-style:italic;box-shadow:none;padding:5px;border:1px solid rgba(255,255,255,0.1);max-width:95%}
.sender-name{font-size:11px;opacity:0.5;font-weight:600;display:block;margin-bottom:4px}.message img{max-width:100%;border-radius:12px;margin-top:5px;cursor:pointer}.system-link-btn{display:inline-block;margin-top:8px;background:rgba(116,185,255,0.1);padding:8px 12px;border-radius:8px;color:#74b9ff;font-weight:bold;cursor:pointer;border:1px solid rgba(116,185,255,0.3);font-size:12px}.system-link-btn:hover{background:rgba(116,185,255,0.2)}
#input-container-wrapper{background:var(--head);backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,0.05);width:100%;display:flex;flex-direction:column;}
/* ALINTI KUTUSU STÄ°LÄ° */
#reply-preview-bar{display:none;background:rgba(0,0,0,0.3);padding:8px 15px;font-size:13px;border-left:4px solid var(--ac);justify-content:space-between;align-items:center;color:#ccc;}
#reply-preview-bar span{font-weight:bold;color:var(--ac);margin-right:5px;}
.reply-quote-box{font-size:12px;opacity:0.8;margin-bottom:5px;padding:5px 8px;border-left:3px solid rgba(255,255,255,0.5);background:rgba(0,0,0,0.2);border-radius:4px;display:block;}
/* LÄ°NK Ã–NÄ°ZLEME KARTI */
.link-preview-card{display:flex;flex-direction:column;margin-top:8px;background:rgba(0,0,0,0.3);border-radius:10px;overflow:hidden;max-width:300px;border:1px solid rgba(255,255,255,0.1);}
.link-preview-card img{width:100%;height:140px;object-fit:cover;border-radius:0!important;margin:0!important;}
.link-info{padding:10px;}
.link-title{font-weight:bold;font-size:14px;margin-bottom:4px;color:white;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.link-desc{font-size:11px;color:#aaa;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
/* YAZIYOR ANÄ°MASYONU */
#typing-indicator{position:absolute;bottom:70px;left:20px;font-size:12px;color:var(--sec);background:rgba(0,0,0,0.6);padding:4px 10px;border-radius:10px;display:none;align-items:center;gap:5px;z-index:90;}
.typing-dots span{width:4px;height:4px;background:var(--sec);border-radius:50%;display:inline-block;animation:typing 1.4s infinite ease-in-out both;}
.typing-dots span:nth-child(1){animation-delay:-0.32s}.typing-dots span:nth-child(2){animation-delay:-0.16s}
@keyframes typing{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

#input-area{padding:15px;display:flex;align-items:center;gap:8px;width:100%;}#input-area input{flex:1;padding:14px 20px;border-radius:30px;border:1px solid rgba(255,255,255,0.05);background:var(--in);color:white;outline:none;font-size:15px;transition:0.3s;min-width:0}#input-area input:focus{border-color:var(--ac);background:rgba(0,0,0,0.4)}.icon-btn{background:none;border:none;color:var(--sec);font-size:20px;padding:0;cursor:pointer;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;transition:0.2s;flex-shrink:0}.icon-btn:hover{color:var(--ac);background:rgba(255,255,255,0.05)}#voice-msg-btn{width:48px;height:48px;background:var(--ac);border-radius:50%;color:white;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 15px rgba(142,68,173,0.4);border:none;cursor:pointer;flex-shrink:0}#voice-msg-btn.recording{background:var(--d);animation:p 1s infinite}
#send-btn { display: none; }
#emoji-picker{position:absolute;bottom:80px;left:20px;width:280px;background:rgba(30,25,40,0.95);backdrop-filter:blur(15px);border-radius:15px;padding:10px;display:none;grid-template-columns:repeat(7,1fr);gap:5px;box-shadow:0 5px 20px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);z-index:200}#emoji-picker.show{display:grid}.emoji-item{cursor:pointer;font-size:22px;text-align:center;padding:5px;border-radius:5px;transition:0.2s}.emoji-item:hover{background:rgba(255,255,255,0.1);transform:scale(1.2)}#user-list-popup{position:absolute;top:75px;right:15px;width:260px;background:rgba(20,15,25,0.95);backdrop-filter:blur(15px);border-radius:18px;padding:0;display:none;flex-direction:column;z-index:2000;box-shadow:0 15px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.1)}#user-list-popup h4{margin:0;padding:18px;background:rgba(255,255,255,0.03);font-size:14px;border-bottom:1px solid rgba(255,255,255,0.05)}#user-list-content{list-style:none;padding:5px 0;margin:0;max-height:250px;overflow-y:auto}#user-list-content li{padding:12px 20px;border-bottom:1px solid rgba(255,255,255,0.02);font-size:14px;display:flex;align-items:center;gap:12px;cursor:pointer}#user-list-content li:hover{background:rgba(255,255,255,0.05)}.status-dot{width:8px;height:8px;border-radius:50%;background:#555}.online .status-dot{background:var(--s);box-shadow:0 0 8px var(--s)}.media-icons{margin-left:auto;display:flex;gap:8px;opacity:0.8}#fullscreen-layer{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:5000;display:none;justify-content:center;align-items:center}#fullscreen-video{width:100%;height:100%;object-fit:contain}#fullscreen-video:hover{transform:none!important;border-color:transparent!important;box-shadow:none!important}#close-fs-btn{position:absolute;top:30px;left:30px;background:rgba(0,0,0,0.5);color:white;border:1px solid rgba(255,255,255,0.2);padding:12px 24px;border-radius:30px;cursor:pointer;z-index:5002;backdrop-filter:blur(5px)}#close-fs-btn:hover{background:rgba(255,255,255,0.1)}
#image-modal {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:6000;display:none;justify-content:center;align-items:center;}
#image-modal img {max-width:95%;max-height:95%;border-radius:5px;box-shadow:0 0 20px rgba(0,0,0,0.5);}
#close-img-btn{position:absolute;top:20px;right:20px;color:white;font-size:30px;cursor:pointer;background:none;border:none;}
#minimize-icon{display:none;width:100%;height:100%;justify-content:center;align-items:center;font-size:24px}#floating-header{display:none;justify-content:space-between;align-items:center;padding:12px 20px;background:rgba(30,25,40,0.9);border-top-left-radius:15px;border-top-right-radius:15px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.1)}#notification-badge{position:absolute;top:-5px;right:-5px;background:var(--d);font-size:12px;font-weight:bold;width:24px;height:24px;border-radius:50%;display:none;justify-content:center;align-items:center;border:2px solid var(--bg);animation:b 0.5s}body.cinema-mode #chat-wrapper{position:fixed;right:20px;bottom:20px;width:340px;height:500px;background:rgba(15,12,19,0.85);backdrop-filter:blur(15px);border-radius:15px;z-index:5001;border:1px solid rgba(255,255,255,0.1);box-shadow:0 10px 40px rgba(0,0,0,0.6)}body.cinema-mode #floating-header{display:flex}body.cinema-mode #chat-wrapper.minimized{width:60px;height:60px;border-radius:50%;background:var(--ac-grad);right:20px;bottom:30px;cursor:pointer;box-shadow:0 5px 20px rgba(142,68,173,0.5);overflow:visible}body.cinema-mode #chat-wrapper.minimized #chat-area,body.cinema-mode #chat-wrapper.minimized #input-container-wrapper,body.cinema-mode #chat-wrapper.minimized #floating-header{display:none}body.cinema-mode #chat-wrapper.minimized #minimize-icon{display:flex}.remember-container{display:flex;align-items:center;gap:8px;margin-bottom:15px;font-size:14px;color:var(--sec);justify-content:center}.remember-container input{width:16px;height:16px;cursor:pointer}#logout-btn{background:rgba(231,76,60,0.2);color:var(--d)}#logout-btn:hover{background:var(--d);color:white}@media (max-width:600px){body.cinema-mode #chat-wrapper{width:90%;right:5%;bottom:30px;height:50%}body.cinema-mode #chat-wrapper.minimized{right:20px;bottom:80px;width:50px;height:50px}.auth-container{width:85%}#input-area{padding:10px 5px;gap:4px}.icon-btn{width:34px;height:34px;font-size:18px}#voice-msg-btn{width:40px;height:40px;font-size:18px}#input-area input{padding:10px 15px;font-size:14px}#emoji-picker{width:90%;left:5%;bottom:70px}}@keyframes b{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}@keyframes p{0%{box-shadow:0 0 0 0 rgba(231,76,60,0.7)}70%{transform:scale(1.1);box-shadow:0 0 0 10px rgba(231,76,60,0)}100%{box-shadow:0 0 0 0 rgba(231,76,60,0)}}
</style>
</head>
<body>
<div id="image-modal"><button id="close-img-btn" onclick="closeImageModal()"><i class="fas fa-times"></i></button><img id="modal-img" src=""></div>
<div id="fullscreen-layer"><button id="close-fs-btn" onclick="closeFullscreen()"><i class="fas fa-times"></i> Kapat</button><video id="fullscreen-video" autoplay playsinline></video></div>
<div id="auth-screen">
<img src="image_0.png" style="width:120px;height:120px;border-radius:50%;object-fit:cover;margin-bottom:30px;border:4px solid var(--ac);box-shadow:0 0 30px var(--ac-g);" onerror="this.src='https://cdn-icons-png.flaticon.com/512/134/134914.png'">
<div class="auth-container">
<div class="auth-tabs"><div class="auth-tab active" onclick="switchTab('login')">GiriÅŸ Yap</div><div class="auth-tab" onclick="switchTab('register')">KayÄ±t Ol</div></div>
<div id="login-form" class="auth-form active">
    <input type="text" id="login-nick" class="login-input" placeholder="KullanÄ±cÄ± AdÄ±">
    <input type="password" id="login-pass" class="login-input" placeholder="Åžifreniz">
    <div class="remember-container"><input type="checkbox" id="remember-me"> <label for="remember-me">Beni HatÄ±rla</label></div>
    <button class="primary-btn" onclick="doLogin()">GiriÅŸ Yap</button>
</div>
<div id="register-form" class="auth-form"><input type="text" id="reg-nick" class="login-input" placeholder="KullanÄ±cÄ± AdÄ± Belirle"><input type="password" id="reg-pass" class="login-input" placeholder="Åžifre Belirle"><button class="primary-btn" onclick="doRegister()">KayÄ±t Ol</button></div>
<div id="auth-msg" class="status-msg"></div></div></div>
<div id="room-pass-screen" style="display:none;">
<i class="fas fa-lock" style="font-size:60px;color:var(--ac);margin-bottom:25px;filter:drop-shadow(0 0 20px var(--ac-g));"></i>
<h3 style="margin-bottom:20px;font-weight:300;letter-spacing:1px;">Oda GÃ¼venlik Åžifresi</h3>
<input type="password" id="room-pass" class="login-input" style="width:280px;" placeholder="Oda Åžifresi"><button class="primary-btn" style="width:280px;margin-top:20px;" onclick="checkRoomPass()">Odaya Gir</button><div id="room-error" class="status-msg error"></div></div>
<div id="main-container">
<header id="app-header">
<div class="header-info"><img src="image_0.png" class="header-avatar" onerror="this.src='https://cdn-icons-png.flaticon.com/512/134/134914.png'"><div class="header-text"><h3>MevlÃ¼t & AyÅŸegÃ¼l</h3><span id="connection-status">BaÄŸlandÄ±</span></div></div>
<div class="header-actions">
<button id="toggle-video-btn" class="circle-btn" onclick="toggleVideoContainer()"><i class="fas fa-eye-slash"></i></button>
<button class="circle-btn" onclick="toggleUserList()"><i class="fas fa-users"></i></button>
<button id="mic-toggle-btn" class="circle-btn" onclick="toggleMic()"><i class="fas fa-microphone-slash"></i></button>
<button id="cam-toggle-btn" class="circle-btn" onclick="toggleCamera()"><i class="fas fa-video"></i></button>
<button id="screen-share-btn" class="circle-btn" onclick="toggleScreenShare()"><i class="fas fa-desktop"></i></button>
<button id="logout-btn" class="circle-btn" onclick="doLogout()" title="Ã‡Ä±kÄ±ÅŸ Yap"><i class="fas fa-sign-out-alt"></i></button>
</div></header>
<div id="user-list-popup"><h4><i class="fas fa-circle" style="font-size:10px;color:var(--s);margin-right:8px;"></i> Aktif KiÅŸiler</h4><ul id="user-list-content"></ul></div>
<div id="video-container"><div id="video-grid"></div></div>
<div id="chat-wrapper" onclick="handleWrapperClick()">
<div id="notification-badge">0</div><div id="minimize-icon"><i class="fas fa-comment-dots"></i></div>
<div id="floating-header"><span>Sohbet</span><i class="fas fa-chevron-down" id="minimize-btn" onclick="minimizeChat(event)"></i></div>
<div id="chat-area"></div>
<div id="typing-indicator"><div class="typing-dots"><span></span><span></span><span></span></div> <span id="typing-text">yazÄ±yor...</span></div>
<div id="input-container-wrapper">
    <div id="reply-preview-bar">
        <div><span><i class="fas fa-reply"></i></span> <span id="reply-target-user"></span> <small id="reply-target-text"></small></div>
        <i class="fas fa-times" style="cursor:pointer;" onclick="cancelReply()"></i>
    </div>
    <div id="input-area">
    <input type="file" id="file-input" hidden accept="image/*" onchange="sendImage()">
    <button class="icon-btn" onclick="document.getElementById('file-input').click()"><i class="fas fa-plus"></i></button>
    <button class="icon-btn" onclick="toggleEmoji()"><i class="far fa-smile"></i></button>
    <input type="text" id="msg-input" placeholder="Mesaj yaz..." autocomplete="off" oninput="handleInput()">
    <button id="send-btn" class="icon-btn" onclick="sendMessage()"><i class="fas fa-paper-plane" style="color:var(--ac)"></i></button>
    <button id="voice-msg-btn" onclick=""><i class="fas fa-microphone"></i></button>
    <div id="emoji-picker"></div>
    </div>
</div>
</div></div>
<script src="/socket.io/socket.io.js"></script><script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
if(window.visualViewport){window.visualViewport.addEventListener('resize',()=>{document.documentElement.style.setProperty('--app-height',`${window.visualViewport.height}px`);scrollToBottom()});document.documentElement.style.setProperty('--app-height',`${window.visualViewport.height}px`)}
function isMobile(){return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}
if(isMobile())document.getElementById('screen-share-btn').style.display='none';
const socket=io();let myPeer,myPeerId,cameraStream=null,screenStream=null,currentActiveStream=null;let myNickname="";const ROOM_ID="ozel-oda-v1";
const videoGrid=document.getElementById('video-grid');const activeCalls={};const videoElements={};const userStreams={};
let connectedPeerIds=[]; let userStatusMap={};
const myVideo=document.createElement('video');myVideo.muted=true;myVideo.setAttribute('playsinline','');myVideo.autoplay=true;myVideo.className='camera-mode';
const notifyAudio = new Audio("data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAFAAAAZgAdf39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f38AAAAATGF2YzU4LjkxLjEwMAAAAAAAAAAAAAAA//uQZAAP8AAAaQAAAADXAAaQAAAA0gAAABpAAABpAAAAGkAAAGkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJ/8z8AABpA/8z8AABpAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAP8AAAaQAAAADXAAaQAAAA0gAAABpAAABpAAAAGkAAAGkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJ/8z8AABpA/8z8AABpAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"); 
if("Notification" in window) Notification.requestPermission();
window.onload=()=>{const u=localStorage.getItem('chat_user');const p=localStorage.getItem('chat_pass');if(u&&p)socket.emit('login',u,p); toggleInputButtons();};
function getEmptyStream(){const c=document.createElement('canvas');c.width=1;c.height=1;const s=c.captureStream(1);const a=new AudioContext();const o=a.createMediaStreamDestination();const t=o.stream.getAudioTracks()[0];s.addTrack(t);return s}
function getTime(){return new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'})}
function switchTab(t){document.querySelectorAll('.auth-tab').forEach(e=>e.classList.remove('active'));document.querySelectorAll('.auth-form').forEach(e=>e.classList.remove('active'));document.getElementById('auth-msg').innerText="";if(t==='login'){document.querySelectorAll('.auth-tab')[0].classList.add('active');document.getElementById('login-form').classList.add('active')}else{document.querySelectorAll('.auth-tab')[1].classList.add('active');document.getElementById('register-form').classList.add('active')}}
function doRegister(){socket.emit('register',document.getElementById('reg-nick').value.trim(),document.getElementById('reg-pass').value.trim())}
function doLogin(){const u=document.getElementById('login-nick').value.trim();const p=document.getElementById('login-pass').value.trim();if(document.getElementById('remember-me').checked){localStorage.setItem('chat_user',u);localStorage.setItem('chat_pass',p)}socket.emit('login',u,p)}
function doLogout(){localStorage.removeItem('chat_user');localStorage.removeItem('chat_pass');location.reload()}
function showAuthMsg(m,t){const e=document.getElementById('auth-msg');e.innerText=m;e.className="status-msg "+t}
socket.on('auth-error',m=>showAuthMsg(m,"error"));socket.on('register-success',m=>{showAuthMsg(m,"success");setTimeout(()=>switchTab('login'),1000)});
socket.on('login-success',u=>{myNickname=u;document.getElementById('auth-screen').style.display='none';document.getElementById('room-pass-screen').style.display='flex'});
function checkRoomPass(){const p=document.getElementById('room-pass').value;socket.emit('check-room-pass',p)}
socket.on('room-pass-success',()=>{document.getElementById('room-pass-screen').style.display='none';startChatApp()});
socket.on('room-pass-error',()=>{document.getElementById('room-error').innerText="HatalÄ± Åžifre!"});
function startChatApp(){document.getElementById('main-container').style.display='flex';currentActiveStream=getEmptyStream();myPeer=new Peer(undefined,{path:'/peerjs',host:location.hostname,port:location.port||(location.protocol==='https:'?443:80),config:{iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:global.stun.twilio.com:3478'}]}});myPeer.on('open',id=>{myPeerId=id;socket.emit('join-room',ROOM_ID,myPeerId,myNickname)});prepareMedia();document.getElementById('msg-input').addEventListener('keydown',e=>{if(e.key==='Enter')sendMessage()})}
function toggleVideoContainer(){const c=document.getElementById('video-container');const b=document.getElementById('toggle-video-btn');if(c.classList.contains('collapsed')){c.classList.remove('collapsed');b.innerHTML='<i class="fas fa-eye"></i>'}else{c.classList.add('collapsed');b.innerHTML='<i class="fas fa-eye-slash"></i>'}}
function toggleUserList(){const l=document.getElementById('user-list-popup');l.style.display=(l.style.display==='flex')?'none':'flex'}
socket.on('update-user-list',u=>{const l=document.getElementById('user-list-content');l.innerHTML="";connectedPeerIds=[];u.forEach(x=>{userStatusMap[x.peerId]=x;if(x.peerId&&x.peerId!==myPeerId&&x.online)connectedPeerIds.push(x.peerId);const i=document.createElement('li');i.className=x.online?'online':'offline';let h='';if(x.online){if(x.cam)h+='<i class="fas fa-video media-icon" style="color:var(--ac)"></i>';if(x.screen)h+='<i class="fas fa-desktop media-icon" style="color:#3498db"></i>'}i.innerHTML=`<div class="status-dot"></div><span>${x.nickname}</span> <div class="media-icons">${h}</div>`;if(x.online&&(x.cam||x.screen)){i.onclick=()=>window.focusUserVideo(x.peerId)}l.appendChild(i)});updateVideoGrid(connectedPeerIds)});
function updateVideoGrid(peers){peers.forEach(pid=>{const el=videoElements[pid];if(el){const status=userStatusMap[pid];if(status&&(status.cam||status.screen)){el.style.display="block";if(!videoGrid.contains(el))videoGrid.append(el)}else{el.style.display="none"}}})}
window.focusUserVideo=function(p){if(p===myPeerId&&currentActiveStream){openFullscreen(currentActiveStream);return}if(userStreams[p]){openFullscreen(userStreams[p]);return}if(videoElements[p]){openFullscreen(videoElements[p].srcObject);return}alert("BaÄŸlantÄ± bekleniyor veya yayÄ±n yok.")};
function notifyMediaStatus(c,s){socket.emit('media-status',{cam:c,screen:s});if(c||s)socket.emit('stream-notify',{type:s?'screen':'camera',active:true})}
socket.on('user-stream-changed',({peerId,type})=>{const v=videoElements[peerId];if(v){if(type==='screen')v.className='screen-mode';else v.className=''}refreshConnections()});
function prepareMedia(){myPeer.on('call',c=>{c.answer(currentActiveStream);const v=document.createElement('video');v.setAttribute('playsinline','');v.autoplay=true;activeCalls[c.peer]=c;c.on('stream',st=>{userStreams[c.peer]=st;handleIncomingStream(st,c.peer)})});socket.on('user-connected',(uid,name)=>{connectToNewUser(uid);renderMessage({type:'system-status',content:`${name} sohbete giriÅŸ yaptÄ±.`,time:getTime()})});socket.on('user-disconnected',(uid,name)=>{if(videoElements[uid])videoElements[uid].remove();delete videoElements[uid];delete userStreams[uid];renderMessage({type:'system-status',content:`${name} sohbetten Ã§Ä±kÄ±ÅŸ yaptÄ±.`,time:getTime()})});myVideo.ondblclick=()=>openFullscreen(currentActiveStream)}
function refreshConnections(){connectedPeerIds.forEach(uid=>{if(activeCalls[uid])activeCalls[uid].close();connectToNewUser(uid)})}
function connectToNewUser(uid){const c=myPeer.call(uid,currentActiveStream);const v=document.createElement('video');v.setAttribute('playsinline','');v.autoplay=true;activeCalls[uid]=c;c.on('stream',st=>{userStreams[uid]=st;handleIncomingStream(st,uid)});c.on('close',()=>{if(videoElements[uid])videoElements[uid].remove();delete videoElements[uid];delete userStreams[uid]})}
function toggleMic(){if(!cameraStream)return alert("Ã–nce Kamera/Mikrofon izni verin");const a=cameraStream.getAudioTracks()[0];const b=document.getElementById('mic-toggle-btn');a.enabled=!a.enabled;if(a.enabled){b.classList.add('active');b.innerHTML='<i class="fas fa-microphone"></i>'}else{b.classList.remove('active');b.innerHTML='<i class="fas fa-microphone-slash"></i>'}}
function toggleCamera(){if(!cameraStream){navigator.mediaDevices.getUserMedia({video:true,audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true}}).then(s=>{
    cameraStream=s; currentActiveStream=s; myVideo.srcObject=s; userStreams[myPeerId]=s;
    const micBtn = document.getElementById('mic-toggle-btn');
    if(!micBtn.classList.contains('active')) { s.getAudioTracks()[0].enabled = false; }
    const b=document.getElementById('cam-toggle-btn');b.classList.add('active');b.innerHTML='<i class="fas fa-video-slash"></i>';if(!videoGrid.contains(myVideo))videoGrid.append(myVideo);notifyMediaStatus(true,false);socket.emit('stream-changed','camera');socket.emit('message','::SYS::'+myPeerId+'::Kamera aÃ§tÄ±');refreshConnections()}).catch(e=>{if(e.name==='NotAllowedError'||e.name==='PermissionDeniedError'){alert("LÃ¼tfen adres Ã§ubuÄŸundaki kilit ikonuna tÄ±klayÄ±p Kamera ve Mikrofon izni verin.")}else{alert("Kamera hatasÄ±: "+e)}});return}if(screenStream)stopScreenShare();const v=cameraStream.getVideoTracks()[0];v.enabled=!v.enabled;if(v.enabled){currentActiveStream=cameraStream;myVideo.srcObject=cameraStream;if(!videoGrid.contains(myVideo))videoGrid.append(myVideo);socket.emit('message','::SYS::'+myPeerId+'::Kamera aÃ§tÄ±')}else{currentActiveStream=getEmptyStream();if(videoGrid.contains(myVideo))myVideo.remove()}const b=document.getElementById('cam-toggle-btn');if(v.enabled){b.classList.add('active');b.innerHTML='<i class="fas fa-video-slash"></i>';notifyMediaStatus(true,false);socket.emit('stream-changed','camera')}else{b.classList.remove('active');b.innerHTML='<i class="fas fa-video"></i>';notifyMediaStatus(false,false)}refreshConnections()}
async function toggleScreenShare(){if(isMobile())return;if(screenStream){stopScreenShare();return}try{screenStream=await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});const m=cameraStream?cameraStream.getAudioTracks()[0]:null;if(m&&m.enabled)screenStream.addTrack(m);document.getElementById('screen-share-btn').classList.add('screen-active');currentActiveStream=screenStream;myVideo.srcObject=screenStream;myVideo.className='screen-mode';userStreams[myPeerId]=screenStream;if(!videoGrid.contains(myVideo))videoGrid.append(myVideo);notifyMediaStatus(false,true);socket.emit('stream-changed','screen');socket.emit('message','::SYS::'+myPeerId+'::Ekran paylaÅŸtÄ±');refreshConnections();screenStream.getVideoTracks()[0].onended=()=>stopScreenShare()}catch(e){}}
function stopScreenShare(){if(!screenStream)return;screenStream.getVideoTracks()[0].stop();screenStream=null;document.getElementById('screen-share-btn').classList.remove('screen-active');if(cameraStream&&cameraStream.getVideoTracks()[0].enabled){currentActiveStream=cameraStream;myVideo.srcObject=cameraStream;myVideo.className=''}else{currentActiveStream=getEmptyStream();if(videoGrid.contains(myVideo))myVideo.remove()}if(cameraStream){const c=cameraStream.getVideoTracks()[0];if(c.enabled){notifyMediaStatus(true,false);socket.emit('stream-changed','camera')}else{notifyMediaStatus(false,false)}}refreshConnections()}
function handleIncomingStream(stream,pid){let v=videoElements[pid];if(!v){v=document.createElement('video');v.setAttribute('playsinline','');v.autoplay=true;videoElements[pid]=v;v.addEventListener('loadedmetadata',()=>v.play().catch(e=>console.log(e)));v.ondblclick=()=>openFullscreen(stream)}v.srcObject=stream;const status=userStatusMap[pid];if(status&&(status.cam||status.screen)){if(!videoGrid.contains(v))videoGrid.append(v);const c=document.getElementById('video-container');if(c.classList.contains('collapsed'))toggleVideoContainer()}else{if(videoGrid.contains(v))v.remove()}}
function openFullscreen(s){const v=document.getElementById('fullscreen-video');v.srcObject=s;document.getElementById('fullscreen-layer').style.display='flex';document.body.classList.add('cinema-mode');v.muted=false;v.play().catch(e=>{})}
function closeFullscreen(){const v=document.getElementById('fullscreen-video');v.muted=true;document.getElementById('fullscreen-layer').style.display='none';document.body.classList.remove('cinema-mode');document.getElementById('chat-wrapper').classList.remove('minimized');document.getElementById('notification-badge').style.display='none'}
function showImageModal(src){const m=document.getElementById('image-modal');const i=document.getElementById('modal-img');i.src=src;m.style.display='flex'}
function closeImageModal(){document.getElementById('image-modal').style.display='none'}
let isChatMinimized=false;let unreadCount=0;
function minimizeChat(e){e.stopPropagation();document.getElementById('chat-wrapper').classList.add('minimized');isChatMinimized=true}
function handleWrapperClick(){if(isChatMinimized){document.getElementById('chat-wrapper').classList.remove('minimized');isChatMinimized=false;unreadCount=0;document.getElementById('notification-badge').style.display='none'}}
// YAZIYOR Ã–ZELLÄ°ÄžÄ°
let typingTimeout;
function handleInput(){
    toggleInputButtons();
    socket.emit('typing');
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => { socket.emit('stop-typing') }, 2000);
}
socket.on('displayTyping', (data) => {
    const el = document.getElementById('typing-indicator');
    document.getElementById('typing-text').innerText = `${data.nickname} yazÄ±yor...`;
    el.style.display = 'flex';
    scrollToBottom();
});
socket.on('hideTyping', (data) => {
    document.getElementById('typing-indicator').style.display = 'none';
});

// YANITLAMA Ã–ZELLÄ°ÄžÄ°
let currentReply = null;
function prepareReply(user, content){
    currentReply = { user, content: content.length > 50 ? content.substring(0,50)+'...' : content };
    document.getElementById('reply-preview-bar').style.display = 'flex';
    document.getElementById('reply-target-user').innerText = user;
    document.getElementById('reply-target-text').innerText = currentReply.content;
    document.getElementById('msg-input').focus();
}
function cancelReply(){
    currentReply = null;
    document.getElementById('reply-preview-bar').style.display = 'none';
}

function toggleInputButtons() {
    const val = document.getElementById('msg-input').value.trim();
    const sendBtn = document.getElementById('send-btn');
    const voiceBtn = document.getElementById('voice-msg-btn');
    if (val.length > 0) { sendBtn.style.display = 'flex'; voiceBtn.style.display = 'none'; }
    else { sendBtn.style.display = 'none'; voiceBtn.style.display = 'flex'; }
}
socket.on('createMessage',d=>renderMessage(d));socket.on('load-history',h=>h.forEach(renderMessage));

function sendMessage(content){
    const inp = document.getElementById('msg-input');
    const val = content || inp.value.trim();
    if(val){
        // YanÄ±t varsa obje olarak gÃ¶nder
        if(currentReply) {
            socket.emit('message', { content: val, replyTo: currentReply });
            cancelReply();
        } else {
            socket.emit('message', val);
        }
        inp.value='';toggleInputButtons();socket.emit('stop-typing');
    }
}

function renderMessage(d){
    if(d.senderId && d.senderId!==socket.id){ 
        if(isChatMinimized){unreadCount++;const b=document.getElementById('notification-badge');b.innerText=unreadCount;b.style.display='flex'}
        if(document.hidden && Notification.permission==="granted") new Notification("Yeni Mesaj", {body: d.user + ": " + (d.type==='text'?d.content:'Medya')});
        notifyAudio.play().catch(()=>{});
        // YazÄ±yor uyarÄ±sÄ±nÄ± gizle
        document.getElementById('typing-indicator').style.display = 'none';
    }
    const a=document.getElementById('chat-area');const m=d.senderId===socket.id;const div=document.createElement('div');
    if(d.type==='system-status'){div.className='message system-status';div.innerHTML=`<div>${d.content}</div>`;a.appendChild(div);a.scrollTop=a.scrollHeight;return}
    div.className=`message ${m?'mine':'theirs'}`;
    
    // Mesaja Ã§ift tÄ±klayÄ±nca yanÄ±tla
    if(d.type === 'text' && !d.content.startsWith('::SYS::')) {
        div.ondblclick = () => prepareReply(d.user, d.content);
        div.title = "Ã‡ift tÄ±kla: YanÄ±tla";
    }

    if(d.type==='text' && !d.content.startsWith('::SYS::') && d.content.length <= 4 && /\p{Emoji}/u.test(d.content)) {
        div.classList.add('big-emoji');
    }

    let replyHtml = '';
    if(d.replyTo) {
        replyHtml = `<span class="reply-quote-box"><b>${d.replyTo.user}</b>: ${d.replyTo.content}</span>`;
    }
    
    let linkPreviewHtml = '';
    if(d.preview) {
        linkPreviewHtml = `
        <a href="${d.content.match(/(https?:\/\/[^\s]+)/)[0]}" target="_blank" style="text-decoration:none;">
            <div class="link-preview-card">
                ${d.preview.image ? `<img src="${d.preview.image}">` : ''}
                <div class="link-info">
                    <div class="link-title">${d.preview.title || 'Link'}</div>
                    <div class="link-desc">${d.preview.description || ''}</div>
                </div>
            </div>
        </a>`;
    }

    if(d.type==='text'&&d.content.startsWith('::SYS::')){const p=d.content.split('::');div.innerHTML=`<span class="sender-name">${d.user}</span><div style="color:var(--sec);font-style:italic;">${p[3]}</div><div class="system-link-btn" onclick="window.focusUserVideo('${p[2]}')">Ä°ZLE</div><div style="font-size:10px;opacity:0.7;text-align:right;">${d.time}</div>`}
    else{
        let c=d.type==='text'?`<div>${d.content}</div>`:d.type==='image'?`<img src="${d.content}" onclick="showImageModal(this.src)">`:`<audio controls src="${d.content}"></audio>`;
        div.innerHTML=`<span class="sender-name" style="${m?'display:none':''}">${d.user}</span>${replyHtml}${c}${linkPreviewHtml}<div style="font-size:10px;opacity:0.7;text-align:right;">${d.time}</div>`
    }
    a.appendChild(div);a.scrollTop=a.scrollHeight
}
function sendImage(){const f=document.getElementById('file-input').files[0];if(f&&f.size<1e8){const r=new FileReader();r.onload=e=>socket.emit('image',e.target.result);r.readAsDataURL(f)}}
const micBtn=document.getElementById('voice-msg-btn');let mediaRec;
const startRec=e=>{if(e.cancelable)e.preventDefault();if(!navigator.mediaDevices)return;navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{mediaRec=new MediaRecorder(s);const c=[];mediaRec.start();micBtn.classList.add('recording');mediaRec.ondataavailable=e=>c.push(e.data);mediaRec.onstop=()=>{const r=new FileReader();r.onloadend=()=>socket.emit('voice',r.result);r.readAsDataURL(new Blob(c,{type:'audio/webm'}));s.getTracks().forEach(t=>t.stop())}})};
const stopRec=e=>{if(e.cancelable)e.preventDefault();if(mediaRec&&mediaRec.state!=='inactive'){mediaRec.stop();micBtn.classList.remove('recording')}};
micBtn.addEventListener('mousedown',startRec);micBtn.addEventListener('mouseup',stopRec);micBtn.addEventListener('touchstart',startRec);micBtn.addEventListener('touchend',stopRec);
function scrollToBottom(){const d=document.getElementById('chat-area');d.scrollTop=d.scrollHeight}
const emojis=["ðŸ˜€","ðŸ˜‚","ðŸ˜","ðŸ˜­","ðŸ˜¡","ðŸ‘","ðŸ‘Ž","ðŸŽ‰","ðŸ”¥","â¤ï¸","ðŸ†","ðŸ‘","ðŸ‘‹","ðŸ‘€","ðŸ’©","ðŸ‘»","ðŸ’€","ðŸ¤¡","ðŸ¤¢","ðŸ¤ ","ðŸ¥¶","ðŸ¥º","ðŸ¤«","ðŸ¤”","ðŸ¥³","ðŸ¤¬"];
const emojiPicker=document.getElementById('emoji-picker');
emojis.forEach(e=>{const s=document.createElement('div');s.className='emoji-item';s.innerText=e;s.onclick=()=>{sendMessage(e);toggleEmoji()};emojiPicker.appendChild(s)});
function toggleEmoji(){emojiPicker.classList.toggle('show')}
document.addEventListener('click',e=>{if(!e.target.closest('#input-area'))emojiPicker.classList.remove('show')});
</script>
</body>
</html>
