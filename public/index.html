<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Mevlüt & Ayşegül</title>
    <link rel="manifest" href="/manifest.json">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0b141a;
            --header-bg: #1f2c34;
            --chat-bg: #0b141a;
            --accent: #00a884;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --app-height: 100dvh; 
        }

        * { box-sizing: border-box; }
        body { 
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); color: var(--text-primary); 
            height: var(--app-height); display: flex; flex-direction: column; overflow: hidden; 
        }

        .hidden { display: none !important; }

        /* AUTH */
        #auth-screen, #room-pass-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111b21; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .auth-container { width: 90%; max-width: 350px; text-align: center; }
        .auth-tabs { display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .auth-tab { padding: 10px 20px; cursor: pointer; color: #888; font-weight: bold; }
        .auth-tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .auth-form { display: none; flex-direction: column; gap: 15px; }
        .auth-form.active { display: flex; }
        .login-input { padding: 15px; border-radius: 25px; border: none; text-align: center; font-size: 16px; background: #2a3942; color: white; outline: none; }
        button.primary-btn { padding: 15px; border-radius: 25px; border: none; background: var(--accent); font-weight: bold; cursor: pointer; font-size: 16px; color: #111b21; transition: 0.3s; }
        .status-msg { margin-top: 10px; font-size: 14px; min-height: 20px; }
        .error { color: #ef5350; } .success { color: #2ecc71; }

        /* HEADER */
        #app-header { background-color: var(--header-bg); padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.3); z-index: 100; }
        .header-info { display: flex; align-items: center; gap: 10px; }
        .header-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        .header-text h3 { margin: 0; font-size: 16px; font-weight: 600; color: var(--text-primary); }
        .header-text span { font-size: 12px; color: var(--accent); }
        .header-actions { display: flex; gap: 10px; }
        .circle-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: rgba(255,255,255,0.05); color: var(--text-secondary); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .circle-btn:hover { background: rgba(255,255,255,0.1); }
        .circle-btn.active { background: var(--accent); color: white; box-shadow: 0 0 10px rgba(0, 168, 132, 0.4); }
        .circle-btn.screen-active { background: #3498db; color: white; box-shadow: 0 0 10px rgba(52, 152, 219, 0.4); }

        /* USER LIST */
        #user-list-popup { position: absolute; top: 60px; right: 10px; width: 220px; background: #2a3942; border-radius: 10px; padding: 0; display: none; flex-direction: column; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #user-list-popup h4 { margin: 0; padding: 12px; background: #202c33; color: var(--text-primary); font-size: 14px; border-bottom: 1px solid #333; }
        #user-list-content { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; }
        #user-list-content li { padding: 10px 15px; border-bottom: 1px solid #333; font-size: 14px; display: flex; align-items: center; gap: 10px; color: var(--text-primary); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .online .status-dot { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .offline { color: #777; }
        .media-icons { margin-left: auto; display: flex; gap: 5px; }
        .media-icon { font-size: 12px; }

        /* VIDEO AREA */
        #video-container { background: #000; overflow: hidden; height: 0; transition: height 0.4s ease-in-out; flex-shrink: 0; position: relative; }
        #video-container.visible { height: 140px; border-bottom: 1px solid #333; }
        #video-grid { display: flex; overflow-x: auto; gap: 8px; height: 100%; padding: 10px; align-items: center; scrollbar-width: none; }
        
        /* Video Stilleri */
        video { height: 100%; border-radius: 8px; border: 1px solid #333; min-width: 140px; background: #111; cursor: pointer; transition: object-fit 0.3s; }
        /* Varsayılan kamera: cover (doldur), Ekran: contain (sığdır) */
        video.camera-mode { object-fit: cover; }
        video.screen-mode { object-fit: contain; border-color: #3498db; }

        /* MAIN & CHAT */
        #main-container { display: none; flex: 1; height: 100%; flex-direction: column; position: relative; }
        #chat-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 5px; background-color: var(--chat-bg); background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; opacity: 0.95; }
        
        #input-area { background: var(--header-bg); padding: 8px 10px; display: flex; align-items: center; gap: 8px; width: 100%; }
        #input-area input { flex: 1; padding: 12px 20px; border-radius: 25px; border: none; background: #2a3942; color: white; outline: none; font-size: 16px; }
        .icon-btn { background: none; border: none; color: var(--text-secondary); font-size: 22px; padding: 8px; cursor: pointer; }
        #mic-btn { width: 45px; height: 45px; background: var(--accent); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        #mic-btn.recording { background: #e74c3c; animation: pulse 1s infinite; }

        /* MESSAGES */
        .message { max-width: 80%; padding: 6px 10px; border-radius: 10px; font-size: 15px; position: relative; word-wrap: break-word; margin-bottom: 2px; }
        .message.mine { align-self: flex-end; background-color: #005c4b; border-top-right-radius: 0; }
        .message.theirs { align-self: flex-start; background-color: #202c33; border-top-left-radius: 0; }
        .sender-name { font-size: 12px; color: #ff9f1c; font-weight: bold; display: block; margin-bottom: 2px; }
        .message img { max-width: 100%; border-radius: 8px; margin-top: 5px; }

        /* FULLSCREEN & CINEMA MODE */
        #fullscreen-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 5000; display: none; justify-content: center; align-items: center; }
        #fullscreen-video { width: 100%; height: 100%; object-fit: contain; }
        #close-fs-btn { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.5); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; z-index: 5002; }

        /* Minimized Chat Elements */
        #minimize-icon { display: none; width: 100%; height: 100%; justify-content: center; align-items: center; color: white; font-size: 24px; }
        #floating-header { display: none; justify-content: space-between; align-items: center; padding: 10px 15px; background: rgba(0,0,0,0.5); color: white; border-top-left-radius: 15px; border-top-right-radius: 15px; cursor: pointer; }
        #notification-badge { position: absolute; top: -5px; right: -5px; background-color: #e74c3c; color: white; font-size: 12px; font-weight: bold; width: 24px; height: 24px; border-radius: 50%; display: none; justify-content: center; align-items: center; border: 2px solid #121212; animation: bounce 0.5s; }

        /* Cinema Mode Styles */
        body.cinema-mode #chat-wrapper { position: fixed; right: 20px; bottom: 20px; width: 320px; height: 450px; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); border-radius: 15px; z-index: 5001; border: 1px solid rgba(255,255,255,0.1); }
        body.cinema-mode #floating-header { display: flex; }
        
        /* Minimized State */
        body.cinema-mode #chat-wrapper.minimized { width: 60px; height: 60px; border-radius: 50%; background: var(--accent); right: 20px; bottom: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); overflow: visible; }
        body.cinema-mode #chat-wrapper.minimized #chat-area, 
        body.cinema-mode #chat-wrapper.minimized #input-area, 
        body.cinema-mode #chat-wrapper.minimized #floating-header { display: none; }
        body.cinema-mode #chat-wrapper.minimized #minimize-icon { display: flex; }

        @media (max-width: 600px) { 
            body.cinema-mode #chat-wrapper { width: 85%; right: 50%; transform: translateX(50%); bottom: 20px; height: 50%; } 
            body.cinema-mode #chat-wrapper.minimized { right: 20px; transform: none; }
        }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="fullscreen-layer">
        <button id="close-fs-btn" onclick="closeFullscreen()"><i class="fas fa-times"></i> Kapat</button>
        <video id="fullscreen-video" autoplay playsinline></video>
    </div>

    <div id="auth-screen">
        <img src="image_0.png" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 20px; border: 3px solid var(--accent);" onerror="this.src='https://cdn-icons-png.flaticon.com/512/134/134914.png'">
        <div class="auth-container">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchTab('login')">Giriş Yap</div>
                <div class="auth-tab" onclick="switchTab('register')">Kayıt Ol</div>
            </div>
            <div id="login-form" class="auth-form active">
                <input type="text" id="login-nick" class="login-input" placeholder="Kullanıcı Adı">
                <input type="password" id="login-pass" class="login-input" placeholder="Şifreniz">
                <button class="primary-btn" onclick="doLogin()">Giriş Yap</button>
            </div>
            <div id="register-form" class="auth-form">
                <input type="text" id="reg-nick" class="login-input" placeholder="Kullanıcı Adı Belirle">
                <input type="password" id="reg-pass" class="login-input" placeholder="Şifre Belirle">
                <button class="primary-btn" onclick="doRegister()">Kayıt Ol</button>
            </div>
            <div id="auth-msg" class="status-msg"></div>
        </div>
    </div>

    <div id="room-pass-screen" style="display: none;">
        <i class="fas fa-lock" style="font-size: 50px; color: var(--accent); margin-bottom: 20px;"></i>
        <h3 style="margin-bottom: 20px; color: var(--text-primary);">Oda Güvenlik Şifresi</h3>
        <input type="password" id="room-pass" class="login-input" style="width: 250px;" placeholder="Oda Şifresi">
        <button class="primary-btn" style="width: 250px; margin-top: 15px;" onclick="checkRoomPass()">Odaya Gir</button>
        <div id="room-error" class="status-msg error"></div>
    </div>

    <div id="main-container">
        <header id="app-header">
            <div class="header-info">
                <img src="image_0.png" class="header-avatar" onerror="this.src='https://cdn-icons-png.flaticon.com/512/134/134914.png'">
                <div class="header-text">
                    <h3>Mevlüt & Ayşegül</h3>
                    <span id="connection-status">Bağlandı</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="circle-btn" onclick="toggleUserList()" title="Kişiler"><i class="fas fa-users"></i></button>
                <button id="cam-toggle-btn" class="circle-btn" onclick="toggleCamera()" title="Kamera"><i class="fas fa-video"></i></button>
                <button id="screen-share-btn" class="circle-btn" onclick="toggleScreenShare()" title="Ekran Paylaş"><i class="fas fa-desktop"></i></button>
            </div>
        </header>

        <div id="user-list-popup">
            <h4>Kişi Listesi</h4>
            <ul id="user-list-content"></ul>
        </div>

        <div id="video-container">
            <div id="video-grid"></div>
        </div>

        <div id="chat-wrapper" onclick="handleWrapperClick()">
            <div id="notification-badge">0</div>
            <div id="minimize-icon"><i class="fas fa-comment-dots"></i></div>
            <div id="floating-header">
                <span>Sohbet</span>
                <i class="fas fa-chevron-down" id="minimize-btn" onclick="minimizeChat(event)"></i>
            </div>
            <div id="chat-area"></div>
            <div id="input-area">
                <input type="file" id="file-input" hidden accept="image/*" onchange="sendImage()">
                <button class="icon-btn" onclick="document.getElementById('file-input').click()"><i class="fas fa-plus"></i></button>
                <input type="text" id="msg-input" placeholder="Mesaj..." autocomplete="off">
                <button class="icon-btn" onclick="sendMessage()"><i class="fas fa-paper-plane" style="color: var(--accent)"></i></button>
                <button id="mic-btn" onclick=""><i class="fas fa-microphone"></i></button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <script>
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                document.documentElement.style.setProperty('--app-height', `${window.visualViewport.height}px`);
                scrollToBottom();
            });
            document.documentElement.style.setProperty('--app-height', `${window.visualViewport.height}px`);
        }

        function isMobile() { return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent); }
        if (isMobile()) document.getElementById('screen-share-btn').style.display = 'none';

        const socket = io();
        let myPeer, myPeerId, cameraStream = null, screenStream = null, currentActiveStream = null;
        let myNickname = "";
        const ROOM_ID = "ozel-oda-v1";
        const ROOM_PASS = "mevlüthanayşegül"; 

        const videoGrid = document.getElementById('video-grid');
        const activeCalls = {};
        const videoElements = {}; 
        
        const myVideo = document.createElement('video');
        myVideo.muted = true; myVideo.setAttribute('playsinline', ''); myVideo.autoplay = true;
        myVideo.className = 'camera-mode'; // Varsayılan

        // AUTH
        function switchTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.getElementById('auth-msg').innerText = "";
            if (tab === 'login') { document.querySelectorAll('.auth-tab')[0].classList.add('active'); document.getElementById('login-form').classList.add('active'); } 
            else { document.querySelectorAll('.auth-tab')[1].classList.add('active'); document.getElementById('register-form').classList.add('active'); }
        }
        function doRegister() { socket.emit('register', document.getElementById('reg-nick').value.trim(), document.getElementById('reg-pass').value.trim()); }
        function doLogin() { socket.emit('login', document.getElementById('login-nick').value.trim(), document.getElementById('login-pass').value.trim()); }
        function showAuthMsg(msg, type) { const el = document.getElementById('auth-msg'); el.innerText = msg; el.className = "status-msg " + type; }
        
        socket.on('auth-error', msg => showAuthMsg(msg, "error"));
        socket.on('register-success', msg => { showAuthMsg(msg, "success"); setTimeout(() => switchTab('login'), 1000); });
        socket.on('login-success', (username) => {
            myNickname = username;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('room-pass-screen').style.display = 'flex';
        });
        function checkRoomPass() {
            if (document.getElementById('room-pass').value === ROOM_PASS) {
                document.getElementById('room-pass-screen').style.display = 'none';
                startChatApp();
            } else { document.getElementById('room-error').innerText = "Hatalı Şifre!"; }
        }

        function startChatApp() {
            document.getElementById('main-container').style.display = 'flex';
            myPeer = new Peer(undefined, { path: '/peerjs', host: location.hostname, port: location.port || (location.protocol === 'https:' ? 443 : 80) });
            myPeer.on('open', id => { myPeerId = id; socket.emit('join-room', ROOM_ID, myPeerId, myNickname); });
            prepareMedia();
            document.getElementById('msg-input').addEventListener('keydown', (e) => { if(e.key === 'Enter') sendMessage(); });
        }

        function checkVideoVisibility() {
            const container = document.getElementById('video-container');
            if (videoGrid.childElementCount > 0) container.classList.add('visible');
            else container.classList.remove('visible');
        }
        
        function toggleUserList() { const list = document.getElementById('user-list-popup'); list.style.display = (list.style.display === 'flex') ? 'none' : 'flex'; }
        
        socket.on('update-user-list', (users) => {
            const list = document.getElementById('user-list-content'); list.innerHTML = "";
            users.forEach(u => {
                const li = document.createElement('li');
                li.className = u.online ? 'online' : 'offline';
                let iconsHtml = '';
                if (u.online) {
                    if (u.cam) iconsHtml += `<i class="fas fa-video media-icon" style="color:var(--accent)"></i>`;
                    if (u.screen) iconsHtml += `<i class="fas fa-desktop media-icon" style="color:#3498db"></i>`;
                }
                li.innerHTML = `<div class="status-dot"></div><span>${u.nickname}</span> <div class="media-icons">${iconsHtml}</div>`;
                if(u.online && (u.cam || u.screen)) li.style.cursor = 'pointer'; li.onclick = () => window.focusUserVideo(u.peerId);
                list.appendChild(li);
            });
        });

        window.focusUserVideo = function(pid) {
            if (pid === myPeerId && currentActiveStream) openFullscreen(currentActiveStream);
            else if (videoElements[pid]) openFullscreen(videoElements[pid].srcObject);
        };
        
        function notifyMediaStatus(c, s) { socket.emit('media-status', { cam: c, screen: s }); }

        // --- STREAM CHANGE HANDLER ---
        socket.on('user-stream-changed', ({ peerId, type }) => {
            const video = videoElements[peerId];
            if (video) {
                if (type === 'screen') {
                    video.className = 'screen-mode'; // CONTAIN
                } else {
                    video.className = 'camera-mode'; // COVER
                }
            }
        });

        // --- MEDIA ---
        function prepareMedia() {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                cameraStream = stream;
                cameraStream.getVideoTracks()[0].enabled = false;
                cameraStream.getAudioTracks()[0].enabled = false;
                currentActiveStream = cameraStream;
                myVideo.ondblclick = () => openFullscreen(currentActiveStream);

                myPeer.on('call', call => {
                    call.answer(currentActiveStream);
                    const video = document.createElement('video'); video.setAttribute('playsinline', ''); video.autoplay = true;
                    activeCalls[call.peer] = call;
                    
                    call.on('stream', userStream => {
                        video.srcObject = userStream;
                        video.ondblclick = () => openFullscreen(userStream);
                        addVideoStream(video, call.peer);
                    });
                });
                socket.on('user-connected', (uid) => connectToNewUser(uid));
            }).catch(e => document.getElementById('cam-toggle-btn').disabled = true);
        }

        function connectToNewUser(uid) {
            const call = myPeer.call(uid, currentActiveStream);
            const video = document.createElement('video'); video.setAttribute('playsinline', ''); video.autoplay = true;
            activeCalls[uid] = call;
            call.on('stream', s => { video.srcObject = s; video.ondblclick = () => openFullscreen(s); addVideoStream(video, uid); });
            call.on('close', () => { video.remove(); delete videoElements[uid]; checkVideoVisibility(); });
        }

        function toggleCamera() {
            if(!cameraStream) return alert("Kamera yok!");
            if(screenStream) stopScreenShare();
            const v = cameraStream.getVideoTracks()[0]; const a = cameraStream.getAudioTracks()[0];
            v.enabled = !v.enabled; a.enabled = v.enabled;
            currentActiveStream = cameraStream; myVideo.srcObject = cameraStream; myVideo.className = 'camera-mode';
            
            const btn = document.getElementById('cam-toggle-btn');
            if(v.enabled) { 
                btn.classList.add('active'); if(!videoGrid.contains(myVideo)) addVideoStream(myVideo, myPeerId); 
                notifyMediaStatus(true,false); socket.emit('stream-changed', 'camera');
            } else { 
                btn.classList.remove('active'); myVideo.remove(); checkVideoVisibility(); 
                notifyMediaStatus(false,false); 
            }
            replaceTracksForEveryone(cameraStream);
        }

        async function toggleScreenShare() {
            if(isMobile()) return;
            if(screenStream) { stopScreenShare(); return; }
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:false});
                const mic = cameraStream.getAudioTracks()[0];
                if(mic) { mic.enabled = true; screenStream.addTrack(mic); }
                
                document.getElementById('screen-share-btn').classList.add('screen-active');
                currentActiveStream = screenStream; myVideo.srcObject = screenStream; myVideo.className = 'screen-mode'; // CONTAIN
                if(!videoGrid.contains(myVideo)) addVideoStream(myVideo, myPeerId);
                checkVideoVisibility();
                notifyMediaStatus(false,true); socket.emit('stream-changed', 'screen');
                replaceTracksForEveryone(screenStream);
                screenStream.getVideoTracks()[0].onended = () => stopScreenShare();
            } catch(e){}
        }

        function stopScreenShare() {
            if(!screenStream) return;
            screenStream.getVideoTracks()[0].stop(); screenStream = null;
            document.getElementById('screen-share-btn').classList.remove('screen-active');
            currentActiveStream = cameraStream; myVideo.srcObject = cameraStream; myVideo.className = 'camera-mode';
            
            const cam = cameraStream.getVideoTracks()[0];
            if(document.getElementById('cam-toggle-btn').classList.contains('active')) {
                cam.enabled = true; notifyMediaStatus(true,false); socket.emit('stream-changed', 'camera');
            } else {
                cam.enabled = false; myVideo.remove(); checkVideoVisibility(); notifyMediaStatus(false,false);
            }
            replaceTracksForEveryone(cameraStream);
        }

        function replaceTracksForEveryone(str) {
            const v = str.getVideoTracks()[0]; const a = str.getAudioTracks()[0];
            for(let p in activeCalls) {
                const s = activeCalls[p].peerConnection.getSenders();
                const vs = s.find(k=>k.track&&k.track.kind==='video');
                const as = s.find(k=>k.track&&k.track.kind==='audio');
                if(vs&&v) vs.replaceTrack(v); if(as&&a) as.replaceTrack(a);
            }
        }
        function addVideoStream(video, pid) {
            video.addEventListener('loadedmetadata', ()=>video.play());
            if(!videoGrid.contains(video)) videoGrid.append(video);
            if(pid) videoElements[pid] = video;
            checkVideoVisibility();
        }

        // FULLSCREEN
        function openFullscreen(stream) {
            const v = document.getElementById('fullscreen-video'); v.srcObject = stream;
            document.getElementById('fullscreen-layer').style.display = 'flex';
            document.body.classList.add('cinema-mode');
        }
        function closeFullscreen() {
            document.getElementById('fullscreen-layer').style.display = 'none';
            document.body.classList.remove('cinema-mode');
            const wrapper = document.getElementById('chat-wrapper');
            wrapper.classList.remove('minimized');
            document.getElementById('notification-badge').style.display = 'none';
        }

        let isChatMinimized = false; let unreadCount = 0;
        function minimizeChat(e) { e.stopPropagation(); document.getElementById('chat-wrapper').classList.add('minimized'); isChatMinimized = true; }
        function handleWrapperClick() {
            if (isChatMinimized) {
                document.getElementById('chat-wrapper').classList.remove('minimized');
                isChatMinimized = false; unreadCount = 0;
                document.getElementById('notification-badge').style.display = 'none';
            }
        }

        socket.on('createMessage', data => renderMessage(data));
        socket.on('load-history', history => history.forEach(renderMessage));
        function sendMessage() {
            const val = document.getElementById('msg-input').value;
            if(val.trim()) { socket.emit('message', val); document.getElementById('msg-input').value = ''; }
        }
        function renderMessage(data) {
            if (isChatMinimized && data.senderId !== socket.id) {
                unreadCount++; const b = document.getElementById('notification-badge'); b.innerText = unreadCount; b.style.display = 'flex';
            }
            const area = document.getElementById('chat-area');
            const isMine = data.senderId === socket.id;
            const div = document.createElement('div');
            div.className = `message ${isMine ? 'mine' : 'theirs'}`;
            let content = data.type === 'text' ? `<div>${data.content}</div>` : 
                          data.type === 'image' ? `<img src="${data.content}">` : 
                          `<audio controls src="${data.content}"></audio>`;
            div.innerHTML = `<span class="sender-name" style="${isMine?'display:none':''}">${data.user}</span>${content}<div style="font-size:10px; opacity:0.7; text-align:right;">${data.time}</div>`;
            area.appendChild(div); area.scrollTop = area.scrollHeight;
        }
        function sendImage() {
            const f = document.getElementById('file-input').files[0];
            if(f && f.size < 1e8) { const r = new FileReader(); r.onload = e => socket.emit('image', e.target.result); r.readAsDataURL(f); }
        }
        const micBtn = document.getElementById('mic-btn');
        let mediaRec;
        const startRec = (e) => {
            if(e.cancelable) e.preventDefault(); if(!navigator.mediaDevices) return;
            navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                mediaRec = new MediaRecorder(s); const chunks = []; mediaRec.start(); micBtn.classList.add('recording');
                mediaRec.ondataavailable = e => chunks.push(e.data);
                mediaRec.onstop = () => { const r = new FileReader(); r.onloadend = () => socket.emit('voice', r.result); r.readAsDataURL(new Blob(chunks, {type:'audio/webm'})); s.getTracks().forEach(t=>t.stop()); };
            });
        };
        const stopRec = (e) => { if(e.cancelable) e.preventDefault(); if(mediaRec && mediaRec.state !== 'inactive') { mediaRec.stop(); micBtn.classList.remove('recording'); } };
        micBtn.addEventListener('mousedown', startRec); micBtn.addEventListener('mouseup', stopRec);
        micBtn.addEventListener('touchstart', startRec); micBtn.addEventListener('touchend', stopRec);
        function scrollToBottom() { const d = document.getElementById('chat-area'); d.scrollTop = d.scrollHeight; }
    </script>
</body>
</html>
